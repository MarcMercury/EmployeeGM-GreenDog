name: Slack Sync Scheduler (Backup)

# ============================================================
# BACKUP TRIGGER: Primary sync now runs via Vercel Cron (vercel.json)
# at /api/cron/slack-sync every 6 hours with Authorization: Bearer auth.
#
# This GitHub Actions workflow is a FALLBACK that runs every 12 hours
# in case Vercel Cron misses a cycle.
#
# REQUIRED GITHUB SECRETS:
# - APP_URL: Your Vercel deployment URL (e.g., https://employee-gm-green-dog.vercel.app)
# - CRON_SECRET: Must match CRON_SECRET env var in Vercel
# ============================================================

on:
  schedule:
    # Run every 12 hours as backup (Vercel cron is primary at 6h)
    - cron: '0 */12 * * *'
  workflow_dispatch:
    # Allow manual trigger from GitHub Actions UI

jobs:
  sync-slack-users:
    runs-on: ubuntu-latest
    steps:
      - name: Validate Configuration
        run: |
          if [ -z "${{ secrets.APP_URL }}" ]; then
            echo "❌ ERROR: APP_URL secret is not configured"
            echo "Please add APP_URL to your repository secrets (e.g., https://employee-gm-green-dog.vercel.app)"
            exit 1
          fi
          if [ -z "${{ secrets.CRON_SECRET }}" ]; then
            echo "⚠️ WARNING: CRON_SECRET is not configured (sync will fail authentication)"
          fi
          echo "✅ Configuration validated"

      - name: Run Slack Sync (via Vercel Cron endpoint)
        run: |
          response=$(curl -s -w "\n%{http_code}" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            "${{ secrets.APP_URL }}/api/cron/slack-sync")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "Response: $body"
          echo "HTTP Code: $http_code"
          
          if [ "$http_code" != "200" ]; then
            echo "❌ Sync failed with status $http_code"
            exit 1
          fi
          
          # Check if sync was successful or skipped (both are OK)
          if echo "$body" | grep -q '"ok":true'; then
            if echo "$body" | grep -q '"skipped":true'; then
              echo "⏭️ Slack sync skipped (recent sync exists)"
            else
              echo "✅ Slack sync completed successfully"
            fi
          else
            echo "❌ Slack sync reported issues"
            exit 1
          fi
